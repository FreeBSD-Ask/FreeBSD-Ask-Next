# 第 18.2 节 系统安装

> **注意**
>
> **FreeBSD 默认提供的 IMG 镜像使用 UFS 文件系统。想使用 ZFS 的用户可在存储卡上刻录好 img 正常启动，再插入 U 盘，运行命令 `bsdinstall` 正常安装（安装位置选择 U 盘）即可。如果想在存储卡上使用 ZFS，反过来用 U 盘进行安装即可。——以上为理论，如何引导 ZFS 仍然未知，待测试。**

自树莓派 3B+ 开始，无需任何改动，系统即可从 U 盘启动，经过测试了 FreeBSD 12/13/14 都是支持的，但是速度非常慢，一方面树莓派 3B+ 使用 USB2.0 极大的限制的总线速度，另一方面可能是玄学问题。（测试用的是东芝（TOSHIBA）64GB USB3.0 U 盘 U364 高速迷你车载 U 盘）。

因此 3B+ 不建议使用 U 盘启动，慢的我要打年年猫，年年猫是谁？是一只调皮的野生狸花猫而已。

我们所有要准备的有树莓派 4 板子一块，网线一段，存储卡一枚。从 <FreeBSD.org> 下载适用于树莓派 4 的镜像:

<https://download.freebsd.org/ftp/releases/arm64/aarch64/ISO-IMAGES/13.2/FreeBSD-13.2-RELEASE-arm64-aarch64-RPI.img.xz>

下载后解压缩。使用 rufus 刻录。插入网线，将存储卡插入树莓派，通电等待约五分钟，查看路由器后台获取 IP。建议最后外接个显示器以免卡住了还不知道还在苦等。

**注意：** 刻录完需要挂载 FAT 分区 替换里面的所有文件，否则会启动花屏，替换的文件路径为：

https://github.com/FreeBSD-Ask/FreeBSD-rpi4-firmware

## 【变通方案】FreeBSD 与树莓派 4B 8G 启动失败问题

FreeBSD 13.2-RELEASE 和 14-CURRENT 都无法在 Raspberry Pi 4B 8GB v1.5 上启动。固件已经更新到最新版本。我正在使用 USB 闪存驱动器。官方的 Raspberry Pi OS 可以正常运行。

我已经使用屏幕测试了以下系统，但它们都无法成功启动。在启动过程中，会出现彩虹屏幕。

- FreeBSD-13.2-RELEASE-arm64-aarch64-RPI.img.xz
- FreeBSD-14.0-CURRENT-arm64-aarch64-RPI-20230713-510fd8313800-264135.img.xz
- FreeBSD-14.0-CURRENT-arm64-aarch64-RPI-20230727-474708c334a7-264358.img.xz

我已经使用 Rufus 烧录了提到的镜像并尝试启动，但彩虹屏幕问题仍然存在。我还尝试在 FreeBSD 上下载 sysutils/rpi-firmware 和 sysutils/u-boot-rpi-arm64，然后将它们复制到 FAT 分区。我发现 sysutils/rpi-firmware 的版本仍然是 2021 年的，而且一些文件的日期也是 2021 年。因此，我从官方的 Raspberry Pi 固件存储库下载了固件来替换它们。然而，彩虹屏幕问题仍然存在，我仍然无法启动系统。总的来说，无论是用 FreeBSD 源还是官方的 Raspberry Pi 源替换固件，都会导致彩虹屏幕问题，系统仍然无法启动。我怀疑 FreeBSD 提供的当前固件版本太旧了，并且 U-Boot 可能也存在问题。以上通过他人告知的确是 U-boot 有问题。

然而，奇怪的是，当我用官方的 Raspberry Pi 源中最新版本的 rpi4-firmware 替换了 ports 中的版本，并将其复制到 USB 驱动器后，系统开始循环，并显示以下代码（使用最后替换的 u-boot）：

```
Net: eth0:ethernet@7d580000
PCIe BRCM: link up, 5.0 Gbps x1 (SSC)
starting USB……
Bus xhci_pci:Reglster 58000420 NbrPorts 5
Starting the contorller
USB XHCI 1.00
scanning bug xhci_pci for devices... Unexpected XHCI event TRB, Skipping
6a0 000000004 01000000 01008401)
```

原始作者似乎已经放弃了这个项目，所以我从 ports 存档中 fork 了一个副本。您可以在以下链接找到它：

<https://github.com/FreeBSD-Ask/rpi3-psci-monitor>

<https://github.com/FreeBSD-Ask/freebsd-ports/tree/main/sysutils/rpi-firmware>

另外，raspberrypi-userland 的作者（也是固件的 Port 作者）也已经删除了这个项目。目前该项目没有上游来源。当前的 Raspberry Pi 4B 8GB 版本在启动时存在问题。当前的 u-boot 启动过程会在彩虹屏幕处卡住。详见 <https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=272792>

如果社区或看到此信息的有人能够提供帮助，那将是非常棒的一件事情。

我不确定 uboot 上游是否对这个问题做出了修复（回复我的马克说似乎已经解决了？）。

最后附上临时解决方案：下载 FreeBSD 14 镜像写入后将 FAT 分区内容替换即可

<https://github.com/FreeBSD-Ask/FreeBSD-rpi4-firmware>

## ZFS 与树莓派

```
# gpart show
=>       63  246947777  mmcsd0  MBR  (118G)
         63       1985          - free -  (993K)
       2048     102400       1  fat16  [active]  (50M)
     104448  246835200       2  freebsd  (118G)
  246939648       8192          - free -  (4.0M)

=>        0  246835200  mmcsd0s2  BSD  (118G)
          0        128            - free -  (64K)
        128  230057856         1  freebsd-ufs  (110G)
  230057984   16777216         2  freebsd-swap  (8.0G)

=>      63  60088257  da0  MBR  (29G)
        63      4033       - free -  (2.0M)
      4096  60084224    1  fat32lba  [active]  (29G)
```

```
# bsdinstall
```

安装后复制固件即可，主要不要覆盖了 EFI 分区原有的东西。


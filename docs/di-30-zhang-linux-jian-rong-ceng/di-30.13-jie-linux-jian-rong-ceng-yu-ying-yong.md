# 第 30.13 节 Linux 兼容层与应用


## 直接从 FreeBSD 的命令行运行软件（以 Deepin 兼容层为例）

直接从 FreeBSD 的命令行运行软件而不需要 chroot 的方法：

```shell-session
# sysctl compat.linux.emul_path=/compat/deepin # 立即生效
# echo compat.linux.emul_path=/compat/deepin >> /etc/sysctl.conf # 永久化设置
```
```shell-session
# chroot /compat/deepin/ /bin/bash # 进入兼容层
# mv /lib64/ld-linux-x86-64.so.2 /lib64/ld-linux-x86-64.so.2.back
# ln -s /lib/x86-64-linux-gnu/ld-linux-x86-64.so.2  /lib64/ld-linux-x86-64.so.2
```

然后就不需要 choot 可以直接在终端运行 Linux 的程序了（只是部分）。

## 设置图标双击启动程序（以 Deepin 兼容层为例）

shell 脚本内容：

```shell-session
#!/bin/bash
export LD_library_PATH=$LD_library_PATH:/lib/x86_64-linux-gnu
/opt/QQ/qq --no-sandbox --in-process-gpu 
```

将以上脚本放在 `/compat/deepin/`，然后用 FreeBSD 执行兼容层里的 bash 执行脚本

## 运行 Chrome（以 Ubuntu 兼容层为例）

```shell-session
# wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb # 无需代理软件，可以直连。此时已经位于 Ubuntu 兼容层了。
# apt install ./google-chrome-stable_current_amd64.deb # 此时已经位于 Ubuntu 兼容层了。
```

```shell-session
# /usr/bin/google-chrome-stable --no-sandbox --no-zygote --in-process-gpu  # 此时已经位于 Ubuntu 兼容层了。
```


## 代理软件（以 clash for windows 为例）


Linux 兼容层的代理软件同时会影响 FreeBSD 的网络状态，因此直接在兼容层安装 clash for windows，设置代理的话 FreeBSD 一样可以使用代理访问网站。正常安装配置即可

## sysctl 变量

```shell
root@ykla:~ # sysctl -a -d  | grep compat.linux
hw.snd.compat_linux_mmap: linux mmap compatibility (-1=force disable 0=auto 1=force enable)
compat.linux32: 32-bit Linux emulation
compat.linux32.emulate_i386: Emulate the real i386
compat.linux32.maxvmem: 
compat.linux32.maxssiz: 
compat.linux32.maxdsiz: 
compat.linux: Linux mode
compat.linux.use_real_ifnames: Use FreeBSD interface names instead of generating ethN aliases
compat.linux.emul_path: Linux runtime environment path
compat.linux.oss_version: Linux OSS version
compat.linux.osrelease: Linux kernel OS release
compat.linux.osname: Linux kernel OS name
compat.linux.setid_allowed: Allow setuid/setgid on execve of Linux binary
compat.linux.map_sched_prio: Map scheduler priorities to Linux priorities (not POSIX compliant)
compat.linux.preserve_vstatus: Preserve VSTATUS termios(4) flag
compat.linux.ignore_ip_recverr: Ignore enabling IP_RECVERR
compat.linux.dummy_rlimits: Return dummy values for unsupported Linux-specific rlimits
compat.linux.default_stacksize: Default soft stack size resource limit, or -1 for unlimited
compat.linux.default_openfiles: Default soft openfiles resource limit, or -1 for unlimited
compat.linux.debug: Log warnings from linux(4); or 0 to disable
compat.linuxkpi: LinuxKPI parameters
compat.linuxkpi.skb: LinuxKPI skbuff
compat.linuxkpi.skb.mem_limit: SKB memory limit: 0=no limit, 1=32bit, 2=36bit, other=undef (currently 32bit)
compat.linuxkpi.lkpi_pci_nseg1_fail: Count of busdma mapping failures of single-segment
compat.linuxkpi.task_struct_reserve: Number of struct task and struct mm to reserve for non-sleepable allocations
compat.linuxkpi.net_ratelimit: Limit number of LinuxKPI net messages per second.
compat.linuxkpi.warn_dump_stack: Set to enable stack traces from WARN_ON(). Clear to disable.
compat.linuxkpi.debug: Set to enable pr_debug() prints. Clear to disable.
```

参考译文：

- `hw.snd.compat_linux_mmap`: Linux mmap 兼容性（-1=强制禁用 0=自动 1=强制启用）
- `compat.linux32`: 32 位 Linux 模拟
- `compat.linux32.emulate_i386`: 模拟真正的 i386
- `compat.linux32.maxvmem`:
- `compat.linux32.maxssiz`:
- `compat.linux32.maxdsiz`:
- `compat.linux`: Linux 模式
- `compat.linux.use_real_ifnames`: 使用 FreeBSD 接口名称而不生成 ethN 别名
- `compat.linux.emul_path`: Linux 运行时环境路径
- `compat.linux.oss_version`: Linux OSS 版本
- `compat.linux.osrelease`: Linux 内核操作系统版本
- `compat.linux.osname`: Linux 内核操作系统名称
- `compat.linux.setid_allowed`: 允许在 Linux 二进制文件的 execve 上使用 setuid/setgid
- `compat.linux.map_sched_prio`: 将调度程序优先级映射到 Linux 优先级（不符合 POSIX 标准）
- `compat.linux.preserve_vstatus`: 保留 VSTATUS termios(4) 参数
- `compat.linux.ignore_ip_recverr`: 忽略启用 IP_RECVERR
- `compat.linux.dummy_rlimits`: 对不支持的 Linux 特定资源限制返回虚拟值
- `compat.linux.default_stacksize`: 默认软堆栈大小资源限制，或 -1 表示无限制
- `compat.linux.default_openfiles`: 默认软打开文件资源限制，或 -1 表示无限制
- `compat.linux.debug`: 记录来自 linux(4)的警告；或 0 以禁用
- `compat.linuxkpi`: LinuxKPI 参数
- `compat.linuxkpi.skb`: LinuxKPI skbuff
- `compat.linuxkpi.skb.mem_limit`: SKB 内存限制：0=无限制，1=32 位，2=36 位，其他=未定义（当前为 32 位）
- `compat.linuxkpi.lkpi_pci_nseg1_fail`: 单段总线 DMA 映射失败的计数
- `compat.linuxkpi.task_struct_reserve`: 非可休眠分配所需的 struct task 和 struct mm 的数量
- `compat.linuxkpi.net_ratelimit`: 每秒限制 LinuxKPI 网络消息的数量。
- `compat.linuxkpi.warn_dump_stack`: 设置以启用 WARN_ON() 的堆栈跟踪。清除以禁用。
- `compat.linuxkpi.debug`: 设置以启用 pr_debug() 打印。清除以禁用。

```shell
root@ykla:~ # sysctl -a -d  | grep linux  # 重复部分已经删除
kern.features.linux64: Linux 64bit support
kern.features.linux: Linux 32bit support
kern.features.linuxulator_v4l2: V4L2 ioctl wrapper support in the linuxulator
kern.features.linuxulator_v4l: V4L ioctl wrapper support in the linuxulator
vm.uma.linux_dma_object: 
vm.uma.linux_dma_object.stats: 
vm.uma.linux_dma_object.stats.xdomain: Free calls from the wrong domain
vm.uma.linux_dma_object.stats.fails: Number of allocation failures
vm.uma.linux_dma_object.stats.frees: Total free calls
vm.uma.linux_dma_object.stats.allocs: Total allocation calls
vm.uma.linux_dma_object.stats.current: Current number of allocated items
vm.uma.linux_dma_object.domain: 
vm.uma.linux_dma_object.domain.0: 
vm.uma.linux_dma_object.domain.0.timin: Time since zero long time minimum item count
vm.uma.linux_dma_object.domain.0.limin: Long time minimum item count
vm.uma.linux_dma_object.domain.0.wss: Working set size
vm.uma.linux_dma_object.domain.0.bimin: Minimum item count in this batch
vm.uma.linux_dma_object.domain.0.imin: minimum item count in this period
vm.uma.linux_dma_object.domain.0.imax: maximum item count in this period
vm.uma.linux_dma_object.domain.0.nitems: number of items in this domain
vm.uma.linux_dma_object.limit: 
vm.uma.linux_dma_object.limit.bucket_max: Maximum number of items in each domain's bucket cache
vm.uma.linux_dma_object.limit.sleeps: Total zone limit sleeps
vm.uma.linux_dma_object.limit.sleepers: Number of threads sleeping at limit
vm.uma.linux_dma_object.limit.max_items: Maximum number of allocated and cached items
vm.uma.linux_dma_object.limit.items: Current number of allocated items if limit is set
vm.uma.linux_dma_object.keg: 
vm.uma.linux_dma_object.keg.domain: 
vm.uma.linux_dma_object.keg.domain.0: 
vm.uma.linux_dma_object.keg.domain.0.free_slabs: Unused slabs
vm.uma.linux_dma_object.keg.domain.0.free_items: Items free in the slab layer
vm.uma.linux_dma_object.keg.domain.0.pages: Total pages currently allocated from VM
vm.uma.linux_dma_object.keg.efficiency: Slab utilization (100 - internal fragmentation %)
vm.uma.linux_dma_object.keg.reserve: number of reserved items
vm.uma.linux_dma_object.keg.align: item alignment mask
vm.uma.linux_dma_object.keg.ipers: items available per-slab
vm.uma.linux_dma_object.keg.ppera: pages per-slab allocation
vm.uma.linux_dma_object.keg.rsize: Real object size with alignment
vm.uma.linux_dma_object.keg.name: Keg name
vm.uma.linux_dma_object.bucket_size_max: Maximum allowed per-cpu cache size
vm.uma.linux_dma_object.bucket_size: Desired per-cpu cache size
vm.uma.linux_dma_object.flags: Allocator configuration flags
vm.uma.linux_dma_object.size: Allocation size
vm.uma.linux_dma_pctrie: 
vm.uma.linux_dma_pctrie.stats: 
vm.uma.linux_dma_pctrie.stats.xdomain: Free calls from the wrong domain
vm.uma.linux_dma_pctrie.stats.fails: Number of allocation failures
vm.uma.linux_dma_pctrie.stats.frees: Total free calls
vm.uma.linux_dma_pctrie.stats.allocs: Total allocation calls
vm.uma.linux_dma_pctrie.stats.current: Current number of allocated items
vm.uma.linux_dma_pctrie.domain: 
vm.uma.linux_dma_pctrie.domain.0: 
vm.uma.linux_dma_pctrie.domain.0.timin: Time since zero long time minimum item count
vm.uma.linux_dma_pctrie.domain.0.limin: Long time minimum item count
vm.uma.linux_dma_pctrie.domain.0.wss: Working set size
vm.uma.linux_dma_pctrie.domain.0.bimin: Minimum item count in this batch
vm.uma.linux_dma_pctrie.domain.0.imin: minimum item count in this period
vm.uma.linux_dma_pctrie.domain.0.imax: maximum item count in this period
vm.uma.linux_dma_pctrie.domain.0.nitems: number of items in this domain
vm.uma.linux_dma_pctrie.limit: 
vm.uma.linux_dma_pctrie.limit.bucket_max: Maximum number of items in each domain's bucket cache
vm.uma.linux_dma_pctrie.limit.sleeps: Total zone limit sleeps
vm.uma.linux_dma_pctrie.limit.sleepers: Number of threads sleeping at limit
vm.uma.linux_dma_pctrie.limit.max_items: Maximum number of allocated and cached items
vm.uma.linux_dma_pctrie.limit.items: Current number of allocated items if limit is set
vm.uma.linux_dma_pctrie.keg: 
vm.uma.linux_dma_pctrie.keg.domain: 
vm.uma.linux_dma_pctrie.keg.domain.0: 
vm.uma.linux_dma_pctrie.keg.domain.0.free_slabs: Unused slabs
vm.uma.linux_dma_pctrie.keg.domain.0.free_items: Items free in the slab layer
vm.uma.linux_dma_pctrie.keg.domain.0.pages: Total pages currently allocated from VM
vm.uma.linux_dma_pctrie.keg.efficiency: Slab utilization (100 - internal fragmentation %)
vm.uma.linux_dma_pctrie.keg.reserve: number of reserved items
vm.uma.linux_dma_pctrie.keg.align: item alignment mask
vm.uma.linux_dma_pctrie.keg.ipers: items available per-slab
vm.uma.linux_dma_pctrie.keg.ppera: pages per-slab allocation
vm.uma.linux_dma_pctrie.keg.rsize: Real object size with alignment
vm.uma.linux_dma_pctrie.keg.name: Keg name
vm.uma.linux_dma_pctrie.bucket_size_max: Maximum allowed per-cpu cache size
vm.uma.linux_dma_pctrie.bucket_size: Desired per-cpu cache size
vm.uma.linux_dma_pctrie.flags: Allocator configuration flags
vm.uma.linux_dma_pctrie.size: Allocation size
vfs.nfsd.linux42server: Enable Linux style NFSv4.2 server (non-RFC compliant)
vfs.nfsd.flexlinuxhack: For Linux clients, hack around Flex File Layout bug
net.netlink.debug.nl_linux_debug_level: debuglevel
hw.snd.compat_linux_mmap: linux mmap compatibility (-1=force disable 0=auto 1=force enable)
security.jail.param.linux: Jail Linux parameters
security.jail.param.linux.oss_version: Jail Linux OSS version
security.jail.param.linux.osrelease: Jail Linux kernel OS release
security.jail.param.linux.osname: Jail Linux kernel OS name
security.jail.param.linux.: Jail Linux parameters
```

参考译文：

- `kern.features.linux64`: Linux 64 位支持
- `kern.features.linux`: Linux 32 位支持
- `kern.features.linuxulator_v4l2`: Linuxulator 中的 V4L2 ioctl wrapper 支持
- `kern.features.linuxulator_v4l`: Linuxulator 中的 V4L ioctl wrapper 支持
- `vm.uma.linux_dma_object`:
- `vm.uma.linux_dma_object.stats`:
- `vm.uma.linux_dma_object.stats.xdomain`: 错误领域中的自由调用
- `vm.uma.linux_dma_object.stats.fails`: 分配失败次数
- `vm.uma.linux_dma_object.stats.frees`: 总释放次数
- `vm.uma.linux_dma_object.stats.allocs`: 总分配次数
- `vm.uma.linux_dma_object.stats.current`: 当前已分配项目数
- `vm.uma.linux_dma_object.domain`:
- `vm.uma.linux_dma_object.domain.0`:
- `vm.uma.linux_dma_object.domain.0.timin`: 自零以来的长时间最小项目计数
- `vm.uma.linux_dma_object.domain.0.limin`: 长时间最小项目计数
- `vm.uma.linux_dma_object.domain.0.wss`: 工作集大小
- `vm.uma.linux_dma_object.domain.0.bimin`: 此批次中的最小项目计数
- `vm.uma.linux_dma_object.domain.0.imin`: 此期间的最小项目计数
- `vm.uma.linux_dma_object.domain.0.imax`: 此期间的最大项目计数
- `vm.uma.linux_dma_object.domain.0.nitems`: 此领域中的项目数
- `vm.uma.linux_dma_object.limit`:
- `vm.uma.linux_dma_object.limit.bucket_max`: 每个领域桶缓存的最大项目数
- `vm.uma.linux_dma_object.limit.sleeps`: 总区限制休眠
- `vm.uma.linux_dma_object.limit.sleepers`: 在限制处休眠的线程数
- `vm.uma.linux_dma_object.limit.max_items`: 已分配和缓存的项目的最大数量
- `vm.uma.linux_dma_object.limit.items`: 如果设置了限制，则为当前已分配项目数
- `vm.uma.linux_dma_object.keg`:
- `vm.uma.linux_dma_object.keg.domain`:
- `vm.uma.linux_dma_object.keg.domain.0`:
- `vm.uma.linux_dma_object.keg.domain.0.free_slabs`: 未使用的块
- `vm.uma.linux_dma_object.keg.domain.0.free_items`: 块层中的可用项目
- `vm.uma.linux_dma_object.keg.domain.0.pages`: 从 VM 当前分配的总页数
- `vm.uma.linux_dma_object.keg.efficiency`: 块利用率（100 - 内部碎片化%）
- `vm.uma.linux_dma_object.keg.reserve`: 保留项目数
- `vm.uma.linux_dma_object.keg.align`: 项目对齐掩码
- `vm.uma.linux_dma_object.keg.ipers`: 每块可用的项目数
- `vm.uma.linux_dma_object.keg.ppera`: 每块分配的页数
- `vm.uma.linux_dma_object.keg.rsize`: 实际对象大小（带有对齐）
- `vm.uma.linux_dma_object.keg.name`: 桶名称
- `vm.uma.linux_dma_object.bucket_size_max`: 允许的每个 CPU 缓存大小的最大值
- `vm.uma.linux_dma_object.bucket_size`: 所需的每个 CPU 缓存大小
- `vm.uma.linux_dma_object.flags`: 分配器配置标志
- `vm.uma.linux_dma_object.size`: 分配大小
- `vm.uma.linux_dma_pctrie`:
- `vm.uma.linux_dma_pctrie.stats`:
- `vm.uma.linux_dma_pctrie.stats.xdomain`: 错误领域中的自由调用
- `vm.uma.linux_dma_pctrie.stats.fails`: 分配失败次数
- `vm.uma.linux_dma_pctrie.stats.frees`: 总释放次数
- `vm.uma.linux_dma_pctrie.stats.allocs`: 总分配次数
- `vm.uma.linux_dma_pctrie.stats.current`: 当前已分配项目数
- `vm.uma.linux_dma_pctrie.domain`:
- `vm.uma.linux_dma_pctrie.domain.0`:
- `vm.uma.linux_dma_pctrie.domain.0.timin`: 自零以来的长时间最小项目计数
- `vm.uma.linux_dma_pctrie.domain.0.limin`: 长时间最小项目计数
- `vm.uma.linux_dma_pctrie.domain.0.wss`: 工作集大小
- `vm.uma.linux_dma_pctrie.domain.0.bimin`: 此批次中的最小项目计数
- `vm.uma.linux_dma_pctrie.domain.0.imin`: 此期间的最小项目计数
- `vm.uma.linux_dma_pctrie.domain.0.imax`: 此期间的最大项目计数
- `vm.uma.linux_dma_pctrie.domain.0.nitems`: 此领域中的项目数
- `vm.uma.linux_dma_pctrie.limit`:
- `vm.uma.linux_dma_pctrie.limit.bucket_max`: 每个领域桶缓存的最大项目数
- `vm.uma.linux_dma_pctrie.limit.sleeps`: 总区限制休眠
- `vm.uma.linux_dma_pctrie.limit.sleepers`: 在限制处休眠的线程数
- `vm.uma.linux_dma_pctrie.limit.max_items`: 已分配和缓存的项目的最大数量
- `vm.uma.linux_dma_pctrie.limit.items`: 如果设置了限制，则为当前已分配项目数
- `vm.uma.linux_dma_pctrie.keg`:
- `vm.uma.linux_dma_pctrie.keg.domain`:
- `vm.uma.linux_dma_pctrie.keg.domain.0`:
- `vm.uma.linux_dma_pctrie.keg.domain.0.free_slabs`:

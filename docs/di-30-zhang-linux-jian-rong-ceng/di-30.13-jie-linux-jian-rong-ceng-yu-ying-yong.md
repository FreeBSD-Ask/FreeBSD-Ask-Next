# 第 30.13 节 Linux 兼容层与应用

## Linux 兼容层的声音

**目前Chroot 的 Linux 兼容层内部中没有声音，要想有声音必须在 FreeBSD 中运行 Linux 程序，而不是 chroot，见上一节。**

Ubuntu 兼容层：

```shell
# ee /compat/ubuntu/etc/asound.conf # 写入以下两行,注意那是感叹号 ! 不是 1 
pcm.!sysdefault pcm.plug:oss
pcm.!default pcm.sysdefault
```

## 直接从 FreeBSD 的命令行运行软件（以 Ubuntu 兼容层为例）

直接从 FreeBSD 的命令行运行软件而不需要 chroot 的方法：

①
```shell-session
# sysctl compat.linux.emul_path=/compat/ubuntu # 立即生效
# echo compat.linux.emul_path=/compat/ubuntu >> /etc/sysctl.conf # 永久化设置
```
②
```shell-session
# mv /compat/ubuntu/lib64/ld-linux-x86-64.so.2  /compat/ubuntu/lib64/ld-linux-x86-64.so.2.back
# ln -s /compat/ubuntu/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2 /compat/ubuntu/lib64/ld-linux-x86-64.so.2
```

然后就不需要 choot 可以直接在终端运行 Linux 的程序了（只是部分）需要指定绝对路径。


**Arch 兼容层只需要①，无需②**

参考文献：

- [FREEBSD, SYSTEM ADMINISTRATION
Install Ubuntu base system into FreeBSD’s Linux Binary Compatibility](https://www.micski.dk/2021/12/21/install-ubuntu-base-system-into-freebsds-linux-binary-compatibility/)


## 以普通用户权限运行 QQ

兼容层的用户与 FreeBSD 用户存在 uid 映射关系。

假设你在 FreeBSD 的普通用户名是 ykla，uid 是 1001（正常情况下默认为 1001）：

```shell-session
# useradd --uid 1001 --gid 0 -m ykla # 此步骤在兼容层里操作！
```

**在 Arch 中创建用户 ykla 后，此用户无法用于 yay 安装软件，仍然需要使用 shell 脚本默认创建的 test 用户。**

## 设置图标双击启动程序（以 Arch 兼容层为例）


QQ.desktop 内容：

```shell
[Desktop Entry]
Name=QQ
Exec=/compat/ubuntu/opt/QQ/qq --no-sandbox --in-process-gpu %U
Terminal=false
Type=Application
Icon=/compat/ubuntu/usr/share/icons/hicolor/512x512/apps/qq.png
StartupWMClass=QQ
Categories=Network;
Comment=QQ
MimeType=x-scheme-handler/tencent;
```

将以上脚本放在 `/compat/deepin/`，然后用 FreeBSD 执行兼容层里的 bash 执行脚本

## 运行 Chrome（以 Ubuntu 兼容层为例）

```shell-session
# wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb # 无需代理软件，可以直连。此时已经位于 Ubuntu 兼容层了。
# apt install ./google-chrome-stable_current_amd64.deb # 此时已经位于 Ubuntu 兼容层了。
```

```shell-session
# /usr/bin/google-chrome-stable --no-sandbox --no-zygote --in-process-gpu  # 此时已经位于 Ubuntu 兼容层了。
```


## 代理软件（以 clash for windows 为例）


Linux 兼容层的代理软件同时会影响 FreeBSD 的网络状态，因此直接在兼容层安装 clash for windows，设置代理的话 FreeBSD 一样可以使用代理访问网站。正常安装配置即可


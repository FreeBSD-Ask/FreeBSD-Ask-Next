# 第11.1节 通过 freebsd-update 更新

> 注意：只有一级架构的 release 版本才提供该源。也就是说 current 和 stable 是没有的。 关于架构的支持等级说明请看： [https://www.freebsd.org/platforms](https://www.freebsd.org/platforms)

> **前排提示**
>
> 阿里云云服务器用户升级到 13.x 请看第 2.1 节 “使用 virtio 技术半虚拟化的虚拟机” 部分。

## 更新系统

FreeBSD 提供了实用工具 `freebsd-update` 来安装系统更新，包括升级到大版本。

### 常规的安全更新：

```
# freebsd-update fetch
```

当出现类似于下列信息时：

```
usrlinclude/c++/vl/trllvector usrlinclude/c++/vl/trllversion usrlinclude/c++/v1/trl/wchar.h usr/include/c++/v1/tr1/wctype.h usrlinclude/c++/vllunwind-armh
usrlinclude/c++/v1/unwind-itaniumh usrlinclude/c++/vllunwindh
usr/include/crypto/ cryptodevh usrlinclude/crypto/cbcmac.h usr/include/crypto/deflate.h usrlinclude/crypto/gfmult.h usr/include/crypto/gmac.h
usr/include/crypto/rijndael.h usrlinclude/crypto/rmd160.h usr/include/crypto/xform.h
usr/include/crypto/xformauth.h usr/includecrypto/xformcomp.h usrlincludelcryptolxformenc.h
usr/include/crypto/xformpoly1305.h usrlincludelsys/ cscanatomic.h usrlincludelsys/ cscanbus.h usr/lib/clang/11.0.1
usr/lib/clang/11.0.1/include
:
```

你只需要输入`q`回车即可。然后：

```
# freebsd-update install
```

### 小版本或者大版本更新

> 例如 `13.2` 是要更新到的版本号：

```
# freebsd-update upgrade -r 13.2-RELEASE
```



**以 FreeBSD 13.1-RELEASE 升级 13.2-RELEASE 为例，设备为 i5-3230M 双核，内存 4G（以下均以此为基准）**

当出现类似于下列信息时：

```
root@ykla:/home/ykla # freebsd-update upgrade -r 13.2-RELEASE
src component not installed, skipped
Looking up update.FreeBSD.cn mirrors... none found.
Fetching public key from update.FreeBSD.cn... done.
Fetching metadata signature for 13.1-RELEASE from update.FreeBSD.cn... done.  #这里我使用了 FreeBSD.cn 镜像站，其实换不换这个源速度都差不多，因为都是零碎文件，如果你更新错误，建议换源看看
Fetching metadata index... done.
Fetching 2 metadata files... done.
Inspecting system... done.

The following components of FreeBSD seem to be installed:
kernel/generic kernel/generic-dbg world/base world/lib32

The following components of FreeBSD do not seem to be installed:
world/base-dbg world/lib32-dbg

Does this look reasonable (y/n)? y  #在这里输入 y 回车即可，在检查基本组件的安装情况。

Fetching metadata signature for 13.2-RELEASE from update.FreeBSD.cn... done.
Fetching metadata index... done.
Fetching 1 metadata patches. done.
Applying metadata patches... done.
Fetching 1 metadata files... done.
Inspecting system...    #这里在检查系统，需要等待约 10 分钟。
Fetching files from 13.1-RELEASE for merging... done.
Preparing to download files...    #这里在准备要下载的文件，需要等待约 15 分钟。
Fetching 5614   #这里需要等待约
patches.....10....20....30....40....50....60....70....80....90....100....110....120....130....140....150....160....170....180....190....200....210....220....230....240....250....260....270....280....290....300....310....320....330....340....350....360....370....380....390....400....


…………以下省略………………


```




```
usrlinclude/c++/vl/trllvector usrlinclude/c++/vl/trllversion usrlinclude/c++/v1/trl/wchar.h usr/include/c++/v1/tr1/wctype.h usrlinclude/c++/vllunwind-armh
usrlinclude/c++/v1/unwind-itaniumh usrlinclude/c++/vllunwindh
usr/include/crypto/ cryptodevh usrlinclude/crypto/cbcmac.h usr/include/crypto/deflate.h usrlinclude/crypto/gfmult.h usr/include/crypto/gmac.h
usr/include/crypto/rijndael.h usrlinclude/crypto/rmd160.h usr/include/crypto/xform.h
usr/include/crypto/xformauth.h usr/includecrypto/xformcomp.h usrlincludelcryptolxformenc.h
usr/include/crypto/xformpoly1305.h usrlincludelsys/ cscanatomic.h usrlincludelsys/ cscanbus.h usr/lib/clang/11.0.1
usr/lib/clang/11.0.1/include
:
```

你只需要输入`q`回车即可。然后：

```
# freebsd-update install
```

安装后需要重启系统：

```
# reboot
```

然后再继续完成安装：

```
# freebsd-update install
```

## **故障排除**

### **FreeBSD 升级出错，没有 ntp 用户**

终端执行命令

```
# pw groupadd ntpd -g 123
# pw useradd ntpd -u 123 -g ntpd -h - -d /var/db/ntp -s /usr/sbin/nologin -c "NTP Daemon"
```

## 查看 FreeBSD 版本

>**注意：**
>
>有时候补丁不涉及内核，内核版本就不会变，用 `uname -r` 看不出来，但是用户空间版本会变。所以你可能会看到两个版本，以高的为准。

### freebsd-version 命令

查看 FreeBSD 内核版本和补丁号：

```
ykla@ykla:~ % freebsd-version -k
13.1-RELEASE-p3
```

查看已安装的用户空间的版本和补丁程序级别：

```
ykla@ykla:~ % freebsd-version -u
13.1-RELEASE-p5
```

### uname 命令

```
ykla@ykla:~ % uname -a
FreeBSD ykla 13.1-RELEASE FreeBSD 13.1-RELEASE releng/13.1-n250148-fc952ac2212 GENERIC amd64
```

```
ykla@ykla:~ % uname -mrs
FreeBSD 13.1-RELEASE amd64
```
